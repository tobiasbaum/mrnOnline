<html>
<head>
<title>MRN Online</title>
<script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
<script src="https://unpkg.com/peerjs@1.0.0/dist/peerjs.min.js"></script>
<script>

class SelfPlayer {
  constructor(id, name) {
    this.id = id;
    this.name = name;
  }
}

class OtherPlayer {
  constructor(id, db) {
    this.id = id;
    this.db = db;
  }

  get name() {
    return this.db.get('playerNames', this.id);
  }

}

class Database {

  constructor() {
    this.times = {};
    this.data = {};
  }

  put(time, id, data) {
    if (id in this.times) {
      var lastTime = this.times[id];
      if (lastTime < time) {
        this.times[id] = time;
        this.data[id] = data;
        return 'update';
      } else {
        return 'ignore';
      }
    } else {
      this.times[id] = time;
      this.data[id] = data;
      return 'add';
    }
  }
  
  get(id) {
    return this.data[id];
  }
  
  dumpEntries(conn, databaseName, sender, knownReceivers) {
      let _this = this;
    Object.keys(this.times).forEach(function (id) {
      let packet = {
        src: sender,
        t: _this.times[id],
        rcv: knownReceivers,
        db: databaseName,
        id: id,
        dta: _this.data[id]
      };
      conn.send(packet);
      console.log('dump ' + JSON.stringify(packet) + ' to ' + conn.peer);
    });
  }
}

class DistributedDatabaseSystem {

  constructor(peer, ownName) {
    this.peer = peer;
    this.ownName = ownName;
    this.time = 0;
    this.otherNames = [];
    this.others = [];
    this.callbacks = {add: {}, update: {}, ignore: {}};
    this.databases = {};
  }
  
  connectToNode(id) {
    var conn = this.peer.connect(id, {reliable: true});
    this.addNode(conn);
  }

  addNode(conn) {
    this.otherNames.push(conn.peer);
    this.others.push(conn);
    var _this = this;
    conn.on('data', function(d) {
      _this.handleData(d);
    });
    conn.on('open', function(d) {
      _this.dumpDatabasesTo(conn);
    });
  }
  
  dumpDatabasesTo(conn) {
    for (let [name, db] of Object.entries(this.databases)) {
      db.dumpEntries(conn, name, this.ownName, this.otherNames);
    }
  }

  handleData(d) {
    console.log('received: ' + JSON.stringify(d));
    this.ensureDbExists(d.db);
    var eventType = this.databases[d.db].put(d.t, d.id, d.dta);
    if (this.callbacks[eventType][d.db]) {
      this.callbacks[eventType][d.db](d.id, d.dta);
    }
    if (eventType != 'ignore') {
      this.forwardToFurtherReceivers(d);
    }
    this.establishConnectionToUnknownNodes(d);
  }
  
  ensureDbExists(dbName) {
    if (!this.databases[dbName]) {
      this.databases[dbName] = new Database();
    }
  }
  
  forwardToFurtherReceivers(packet) {
    let furtherReceivers = [];
    let existingSet = new Set(packet.rcv);
    existingSet.add(this.ownName);
    existingSet.add(packet.src);
    this.otherNames.forEach(function (x) {
      if (!existingSet.has(x)) {
        furtherReceivers.push(x);
      }
    });
    packet.rcv.push(...furtherReceivers);
    let _this = this;
    furtherReceivers.forEach(function(id) {
      let index = _this.otherNames.indexOf(id);
      let conn = _this.others[index];
      conn.send(packet)
    });
  }
  
  establishConnectionToUnknownNodes(packet) {
    let _this = this;
    let nameSet = new Set(this.otherNames);
    nameSet.add(this.ownName);
    packet.rcv.filter(x => !nameSet.has(x)).forEach(function (x) {
      _this.connectToNode(x);
    });
    if (!nameSet.has(packet.src)) {
      this.connectToNode(packet.src);
    }
  }
  
  add(listDb, data) {
    this.put(listDb, this.ownName + this.time, data);
  }
  
  put(database, id, data) {
    var packet = {
      src: this.ownName,
      t: this.time++,
      rcv: this.otherNames,
      db: database,
      id: id,
      dta: data
    };
    this.others.forEach(function(x) {
      x.send(packet);
    })
    this.handleData(packet);
  }
  
  get(database, id) {
    if (!this.databases[database]) {
      return undefined;
    }
    return this.databases[database].get(id);
  }
  
  on(eventType, database, action) {
    this.callbacks[eventType][database] = action;
  }

}

class GameField {

  constructor(peer, ownId, ownName) {
    this.others = [];
    this.db = new DistributedDatabaseSystem(peer, ownId);
    var _this = this;
    this.db.on('add', 'messages', function(id, msg) {_this.handleAddedMessage(msg)});
    this.db.on('add', 'playerNames', function(id, name) {_this.handleChangedPlayerName(id, name)});
    this.db.on('update', 'playerNames', function(id, name) {_this.handleChangedPlayerName(id, name)});
    
    this.myself = new SelfPlayer(ownId, ownName);
    this.db.put('playerNames', ownId, ownName);
  }
  
  connectToOtherPlayer(id) {
    this.db.connectToNode(id);
    this.others.push(new OtherPlayer(id, this.db));
    this.updatePlayers();    
  }

  addOtherPlayer(conn) {
    this.db.addNode(conn);
    this.others.push(new OtherPlayer(conn.peer, this.db));
    this.updatePlayers();
  }

  handleChangedPlayerName(id, name) {
    this.updatePlayers();
  }

  updatePlayers() {
    var content = '';
    this.others.forEach(function(x) {
      content += '<div id="' + x.name + '"><h2>' + x.name + ' (' + x.id + ')</h2></div>';
    });
    $('#players').html(content);
  }

  sendMessage(msg) {
    this.db.add('messages', msg);
  }

  handleAddedMessage(msg) {
    $('#messages').append(msg + '\n');
  }
}

function createPeer(name) {
     if (window.mrnOnline) {
         return;
     }
     window.mrnOnline = {};
     //var peer = new Peer(null, {host: '192.168.178.30', port: 9000, key: 'peerjs'});
     var peer = new Peer(null, {host: 'localhost', port: 9000, key: 'peerjs', debug: 2});
     peer.on('error', function (err) {
         console.log(err);
         alert('' + err);
     });
     peer.on('open', function(id) {
         //alert('My peer ID is: ' + id);
         $('#inhalt').html('My peer ID is: ' + id);
         window.mrnOnline.gameField = new GameField(peer, id, name);
     });
     peer.on('connection', function(conn) {
         //alert('Got connection ' + conn);
         window.mrnOnline.gameField.addOtherPlayer(conn);
     });
}

function start() {
     var name = prompt('Name');
     if (name) {
       createPeer(name);
     }
}

function join() {
     var other = prompt('ID des Mitspielers');
     if (other) {
       window.mrnOnline.gameField.connectToOtherPlayer(other);
     }
}

function sendMessage() {
     var message = prompt('Nachricht');
     if (message) {
       window.mrnOnline.gameField.sendMessage(message);
     }
}
</script>
</head>
<body>
<button onClick="javascript:start()">Start</button>
<button onClick="javascript:join()">Join</button>
<button onClick="javascript:sendMessage()">Send message</button>
<div id="inhalt"></div>
<div id="players">
</div>
<textarea id="messages">
</textarea>
</body>
</html>