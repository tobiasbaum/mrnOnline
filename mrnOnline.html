<html>
<head>
<title>MRN Online</title>
<script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
<script src="https://unpkg.com/peerjs@1.0.0/dist/peerjs.min.js"></script>
<script>

class SelfPlayer {
  constructor(id, name) {
    this.id = id;
    this.name = name;
  }
}

class OtherPlayer {
  constructor(conn) {
    this.conn = conn;
  }

  get id() {
    return this.conn.peer;
  }

}

class Database {

  constructor() {
    this.times = {};
    this.data = {};
  }

  put(time, id, data) {
    if (id in this.times) {
      var lastTime = this.times[id];
      if (lastTime < time) {
        this.times[id] = time;
        this.data[id] = data;
        return 'update';
      } else {
        return 'ignore';
      }
    } else {
      this.times[id] = time;
      this.data[id] = data;
      return 'add';
    }
  }
}

class DistributedDatabaseSystem {

  constructor(ownName) {
    this.ownName = ownName;
    this.time = 0;
    this.otherNames = [];
    this.others = [];
    this.callbacks = {add: {}, update: {}, ignore: {}};
    this.databases = {};
  }

  addNode(conn) {
    this.otherNames.push(conn.peer);
    this.others.push(conn);
    var _this = this;
    conn.on('data', function(d) {
      _this.handleData(d);
    });
  }

  handleData(d) {
    this.ensureDbExists(d.db);
    var eventType = this.databases[d.db].put(d.t, d.id, d.dta);
    if (this.callbacks[eventType][d.db]) {
      this.callbacks[eventType][d.db](d.id, d.dta);
    }
  }
  
  ensureDbExists(dbName) {
    if (!this.databases[dbName]) {
      this.databases[dbName] = new Database();
    }
  }
  
  add(listDb, data) {
    this.put(listDb, this.ownName + this.time, data);
  }
  
  put(database, id, data) {
    var packet = {
      src: this.ownName,
      t: this.time++,
      rcv: this.otherNames,
      db: database,
      id: id,
      dta: data
    };
    this.others.forEach(function(x) {
      x.send(packet);
    })
    this.handleData(packet);
  }
  
  on(eventType, database, action) {
    this.callbacks[eventType][database] = action;
  }

}

class GameField {

  constructor(ownId, ownName) {
    this.myself = null;
    this.others = [];
    this.db = new DistributedDatabaseSystem();
    var _this = this;
    this.db.on('add', 'messages', function(id, msg) {_this.handleAddedMessage(msg)});
    
    this.myself = new SelfPlayer(ownId, ownName);
  }

  addOtherPlayer(conn) {
    this.db.addNode(conn);
    this.others.push(new OtherPlayer(conn));
    this.updatePlayers();
  }

  updatePlayers() {
    var content = '';
    this.others.forEach(function(x) {
      content += '<div id="' + x.name + '"><h2>' + x.name + ' (' + x.id + ')</h2></div>';
    });
    $('#players').html(content);
  }

  sendMessage(msg) {
    this.db.add('messages', msg);
  }

  handleAddedMessage(msg) {
    $('#messages').append(msg + '\n');
  }
}

function createPeer(name) {
     if (window.mrnOnline) {
         return;
     }
     window.mrnOnline = {};
     //var peer = new Peer(null, {host: '192.168.178.30', port: 9000, key: 'peerjs'});
     var peer = new Peer(null, {host: 'localhost', port: 9000, key: 'peerjs'});
     peer.on('error', function (err) {
         console.log(err);
         alert('' + err);
     });
     peer.on('open', function(id) {
         //alert('My peer ID is: ' + id);
         $('#inhalt').html('My peer ID is: ' + id);
         window.mrnOnline.gameField = new GameField(id, name);
     });
     peer.on('connection', function(conn) {
         //alert('Got connection ' + conn);
         window.mrnOnline.gameField.addOtherPlayer(conn);
     });
     window.mrnOnline.peer = peer;
}

function start() {
     var name = prompt('Name');
     createPeer(name);
}

function join() {
     var other = prompt('ID des Mitspielers');
     var conn = window.mrnOnline.peer.connect(other);
     window.mrnOnline.gameField.addOtherPlayer(conn);
}

function sendMessage() {
     var message = prompt('Nachricht');
     window.mrnOnline.gameField.sendMessage(message);
}
</script>
</head>
<body>
<button onClick="javascript:start()">Start</button>
<button onClick="javascript:join()">Join</button>
<button onClick="javascript:sendMessage()">Send message</button>
<div id="inhalt"></div>
<div id="players">
</div>
<textarea id="messages">
</textarea>
</body>
</html>